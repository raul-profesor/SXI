
<!doctype html>
<html lang="ca" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://raul-profesor.github.io/SXI/section/P3.2/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Pràctica 3.2 - Configuració de servidor DNS mestre/esclau i millora de la configuració - Servicis en xarxa i Internet</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#practica-32-configuracio-de-servidor-dns-mestreesclau-i-millora-de-la-configuracio" class="md-skip">
          Salta el contingut
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Servicis en xarxa i Internet" class="md-header__button md-logo" aria-label="Servicis en xarxa i Internet" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Servicis en xarxa i Internet
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pràctica 3.2 - Configuració de servidor DNS mestre/esclau i millora de la configuració
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent=""  aria-label="Cambiar a modo normal"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Cambiar a modo normal" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link md-tabs__link--active">
        Pràctiques SXI
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Servicis en xarxa i Internet" class="md-nav__button md-logo" aria-label="Servicis en xarxa i Internet" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Servicis en xarxa i Internet
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../..">Pràctiques SXI</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Pràctiques SXI" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Pràctiques SXI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P1/" class="md-nav__link">
        Pràctica 1 - Muntant l'arquitectura de xarxa
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P2.1/" class="md-nav__link">
        Pràctica 2.1 - Instal·lació i configuració de servidor DHCP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P2.2/" class="md-nav__link">
        Pràctica 2.2 - DHCP Relay
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P3.1/" class="md-nav__link">
        Pràctica 3.1 - Configuració d'un servidor DNS
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pràctica 3.2 - Configuració de servidor DNS mestre/esclau i millora de la configuració
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Pràctica 3.2 - Configuració de servidor DNS mestre/esclau i millora de la configuració
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Taula de continguts">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Taula de continguts
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#millora-de-la-configuracio-del-servidor" class="md-nav__link">
    Millora de la configuració del servidor
  </a>
  
    <nav class="md-nav" aria-label="Millora de la configuració del servidor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pas-1-afegir-subdomini-automaticament" class="md-nav__link">
    Pas 1 – Afegir subdomini automàticament
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pas-2-afegir-el-nostre-servidor-dns-com-a-unic-en-el-client" class="md-nav__link">
    Pas 2 – Afegir el nostre servidor DNS com a únic en el client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pas-3-afegir-forwarders" class="md-nav__link">
    Pas 3 – Afegir forwarders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pas-4-afegir-arxius-de-log" class="md-nav__link">
    Pas 4 - Afegir arxius de log
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuracio-del-servidor-esclau" class="md-nav__link">
    Configuració del servidor esclau
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprovacio-de-la-configuracio" class="md-nav__link">
    Comprovació de la configuració
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#questions-finals" class="md-nav__link">
    Questions finals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#avaluacio" class="md-nav__link">
    Avaluació
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P3.3/" class="md-nav__link">
        Pràctica 3.3 - Configuració de servidor DNS mestre i esclau en diferents xarxes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P4.1/" class="md-nav__link">
        Pràctica 4.1 - Instal·lació i configuració de servidor web NGINX
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P4.2/" class="md-nav__link">
        Pràctica 4.2 - Autenticació en Nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P4.3/" class="md-nav__link">
        Pràctica 4.3 - Proxy invers amb Nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P4.4/" class="md-nav__link">
        Pràctica 4.4 - Balanceig de càrrega amb proxy invers en Nginx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P4.5/" class="md-nav__link">
        Practica 4.5 - Proxy invers i balanceig de càrrega amb SSL en NGINX
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P5.1/" class="md-nav__link">
        Practica 5.1 - Instal·lació i hardening (bastionat) de servici SSH
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../P5.2/" class="md-nav__link">
        Practica 5.2 - SSH amb MFA (Autenticació Multifactor)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../proj/" class="md-nav__link">
        Projecte final - Configuració de servicis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="practica-32-configuracio-de-servidor-dns-mestreesclau-i-millora-de-la-configuracio">Pràctica 3.2 - Configuració de servidor DNS mestre/esclau i millora de la configuració</h1>
<div class="admonition danger">
<p class="admonition-title">Atenció, molt important abans de començar!</p>
<p>✔ Heu de tenir un clon de l'Ubuntu Server, perquè faci de servidor DNS esclau</p>
<p>✔ Aquest servidor esclau tindrà una interfície a la nostra xarxa interna que rebrà la IP per DHCP així que:</p>
<ul>
<li>Aquesta interfície, estarà configurada per a la mateixa xarxa interna que el server original i haurà de tindre configurat en netplan que reba la IP per DHCP</li>
</ul>
<p>✔ Heu de tenir configurat el servidor DHCP perquè assigni una dirección IP fixa a l'Ubuntu Server.</p>
<div class="admonition info">
<p class="admonition-title">Avís</p>
<p>✔ Si ja havíeu clonat el servidor per fer les pràctiques de tema anterior,
podeu reutilitzar-la però recordeu:</p>
<ul>
<li>
<p>Aturar els servicis que tinguéssiu instal·lats (isc-dhcp-server, isc-dhcp-relay)</p>
</li>
<li>
<p>Cal desactivar-una de les interfícies en Virtualbox</p>
</li>
<li>
<p>La interfície de la xarxa interna estarà configurada per a la mateixa xarxa interna que el server original i haurà de tenir configurat en netplan que rebi la IP per DHCP</p>
</li>
<li>
<p>Instal·lar Bind i els paquets addicionals, tal com vam fer en la pràctica anterior al servidor original </p>
</li>
</ul>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Nota important</p>
<p>Si després de configurar-ho tot en la pràctica, no ixen els resultats que deuen, pot passar que s'hagi quedat informació guardada en la caché del client o del server. Per esborrar-les en el client:</p>
<div class="highlight"><pre><span></span><code>sudo systemd-resolve --flush-caches
</code></pre></div>
<p>I en el servidor:</p>
<div class="highlight"><pre><span></span><code>sudo rndc flush
sudo rndc reload
</code></pre></div>
</div>
<h2 id="millora-de-la-configuracio-del-servidor">Millora de la configuració del servidor</h2>
<h3 id="pas-1-afegir-subdomini-automaticament">Pas 1 – Afegir subdomini automàticament</h3>
<p>Si proveu, amb la configuració de la pràctica anterior cal incloure el subdomini al nom de host per poder fer ping i que el DNS resolgui bé les direccions.</p>
<p>Així no funciona:</p>
<p><img alt="" src="../../img/3.2_1.png" /></p>
<p>Així hauria de funcionar:</p>
<p><img alt="" src="../../img/3.2_2.png" /></p>
<p>Podem solucionar això. Hem d'enviar la nostra direcció de domini als hosts per que la afegeixin a la seva IP quan se la assigni el DHCP.
Per això heu d'utilitzar, dins de la declaració de la vostra subnet a l'arxiu de configuració de l'DHCP, la directiva "option domain sre.es".</p>
<h3 id="pas-2-afegir-el-nostre-servidor-dns-com-a-unic-en-el-client">Pas 2 – Afegir el nostre servidor DNS com a únic en el client</h3>
<p>Si us heu fixat en la sortida de dig o de nslookup des del client, quan us diu que servidor DNS ha utilitzat per a la consulta, us posa que ha estat el 127.0.0.53</p>
<p><img alt="" src="../../img/3.2_3.png" /></p>
<p>Aquesta adreça és l'adreça local de la vostra màquina client. Això és així perquè systemd, el “nou” sistema de gestió de servicis de Linux, té una espècie de servidor DNS local que és el primer que es consulta i si no té la resposta, la reenvía al servidor DNS que hàgim configurat.</p>
<p>Això és una falla coneguda de systemd i n'hi ha una espècie de “arranjament” per solucionar-ho i és crear un link simbòlic:</p>
<p><div class="highlight"><pre><span></span><code>$ sudo rm -f /etc/resolv.conf
$ sudo ln -s /run/systemd/resolve/resolv.conf /etc/resolv.conf
</code></pre></div>
I heu de reaplicar la configuració de xarxa:</p>
<div class="highlight"><pre><span></span><code>sudo netplan apply
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Tasca</p>
<p>Feu una nova consulta en dig i comproveu que ara sí ha utilitzat el servidor que deu, és a dir, l'Ubuntu Server que heu configurat vosaltres. Adjunteu captures de pantalla de la configuració i el resultat.</p>
</div>
<h3 id="pas-3-afegir-forwarders">Pas 3 – Afegir forwarders</h3>
<div class="admonition question">
<p class="admonition-title">Tasca</p>
<p>Comproveu que si feu una consulta a una adreça de domini d'Internet (cisco.com, github.com…), el domini sí es resol perfectament. Com és això possible si només hem configurat les zones autoritatives del DNS i cap més? A quins servidors DNS creieu que consulta el nostre Bind?</p>
</div>
<div class="admonition question">
<p class="admonition-title">Tasca</p>
<p>Descomenta en l'arxiu la secció de forwarders i afegeix les següents adreces.
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">forwarders {</span><span class="w"></span>
<span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">208.67.222.222; //Servidor DNS d&#39;Opendns</span><span class="w"></span>
<span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">1.1.1.1; //Servidor DNS de  Cloudflare</span><span class="w">  </span>
<span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">};</span><span class="w"></span>
</code></pre></div></p>
</div>
<div class="admonition question">
<p class="admonition-title">Tasca</p>
<p>Fes un dig a una adreça d'Internet una vegada més. Què creus que hem fet afegint aquestes adreces?</p>
</div>
<div class="admonition question">
<p class="admonition-title">Tasca</p>
<p>Si en l'arxiu “named.conf.options” canvieu la línia “recursion yes;” per “recursion no;”</p>
<ul>
<li>Segueix funcionant la resolució de subdominis externs d'Internet (comprova-ho amb dig o nslookup)? </li>
<li>I els propis (comprova-ho amb dig i amb el nom de domini complet de les màquines .sre.es)?</li>
<li>Per què passa això si tenim els forwarders configurats?</li>
</ul>
</div>
<div class="admonition info">
<p class="admonition-title">Nota</p>
<p>Pot passar que no us funcionen de primeres. En aquest cas, i en el mateix arxiu, proveu a canviar la línia:</p>
<p><div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">dnssec-validation auto;</span><span class="w"></span>
</code></pre></div>
Per:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">dnssec-enable yes;</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">dnssec-validation yes;</span><span class="w"></span>
</code></pre></div>
</div>
<h3 id="pas-4-afegir-arxius-de-log">Pas 4 - Afegir arxius de log</h3>
<p>Històricament tots els servicis de Linux han tingut el que es coneixen com a arxius de logs. Aquests arxius contenen text i registren tota l'activitat del servici, és a dir, tot el que ocorre amb ell. </p>
<p>Hui dia això ho controla systemd i podem veure l'estat i l'activitat del servici amb el comando <code>sudo journalctl -u nom_de el_servici</code>.
No obstant això, anem a afegir els nostres propis arxius de logs per fer-ho més accessible i manejable.</p>
<p>Per a això, en l'arxiu “named.conf” l'indiquem que ha de tenir en compte un nou arxiu de configuració que crearem després per especificar com guardar els logs:</p>
<p><div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">include &quot;/etc/bind/named.conf.logging&quot;;</span><span class="w"></span>
</code></pre></div>
Hem de crear, ara sí, l'arxiu “named.conf.logging” amb el següent contingut:</p>
<p><div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">logging {</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">channel errors_syslog {</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">syslog daemon;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">severity warning;</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">};</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">// Per loggear totes les consultes DNS al servidor</span><span class="w"></span>
<span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">channel queries_log {</span><span class="w"></span>
<span class="hll"><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">file &quot;/var/log/named/queries.log&quot; versions 600 size 20m;</span><span class="w"></span>
</span><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">print-time yes;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">print-category yes;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">print-severity yes;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">severity dynamic;</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">};</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">//Per loggear tots els errors en realitzar consultes al servidor</span><span class="w"></span>
<span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">channel query-errors_log {</span><span class="w"></span>
<span class="hll"><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">file &quot;/var/log/named/query-errors.log&quot; versions 5 size 20m;</span><span class="w"></span>
</span><span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">print-time yes;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">print-category yes;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">print-severity yes;</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">severity dynamic;</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">};</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">//Definim les categories associades als channels</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category lame-servers { null; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category edns-disabled { null; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category resolver { null; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category dnssec { errors_syslog; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category default { errors_syslog; default_debug; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category unmatched { null; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category queries { queries_log; };</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">category query-errors { query-errors_log; };</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">};</span><span class="w"></span>
</code></pre></div>
Fixeu-vos en les parts destacades en groc. Li estem indicant que aquests van a ser els arxius de log on es bolcarà tota la informació corresponent. </p>
<p>No obstant això, comproveu que aquest directori i aquests fitxers no existeixen.</p>
<ul>
<li>Creeu aquest directori amb aquests fitxers</li>
<li>Després de fer-ho, heu de canviar la propietat de l'arxiu a l'usuari “bind”, que és el corresponent al servidor DNS:</li>
</ul>
<div class="highlight"><pre><span></span><code>sudo chown bind.bind nom_de_fitxer
</code></pre></div>
<p>Finalment, a la configuració de Bind cal dir-li que sigui capaç de registrar la informació relativa a les queries o consultes DNS. Per a això modifiquem l'arxiu d'opcions “named.conf.options” i afegim, dins de “options {...}” la línia:</p>
<p><div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">querylog yes;</span><span class="w"></span>
</code></pre></div>
I reiniciem el servici de bind (named).</p>
<div class="admonition question">
<p class="admonition-title">Tasca</p>
<p>Comprova que realitzant ara consultes des del client, queden registrades en aquest arxiu i fes una captura de pantalla.</p>
</div>
<h3 id="configuracio-del-servidor-esclau">Configuració del servidor esclau</h3>
<p>Per configurar el servidor esclau, hem de tenir un clon de nostre servidor i realitzar els mateixos passos per instal·lar Bind.</p>
<p>Aquest servidor esclau serà capaç de resoldre les mateixes consultes que el principal, fins i tot serà capaç de seguir resolent consultes si el principal deixa de funcionar.</p>
<p>Així doncs, després d'instal·lar Bind de la mateixa forma que hem fet en el principal, configurem l'arxiu “named.conf.options” exactament de la mateixa manera també.
Per indicar-li a l'esclau que zones va a rebre, hem d'indicar-li que les mateixes que el mestre però en manera esclava. Quedaria així:</p>
<p><img alt="" src="../../img/esclau_1.png" /></p>
<ul>
<li>
<p>En la configuració posa que es guardaran les zones transferides en el directori “esclaus” dins del directori <code>/etc/bind</code>, així que no oblideu crear aquest directori posat que no existeix. <strong>Si vos dona error per qüestió de permisos, canvieu la ruta per a guardar les zones a <code>/var/cache/bind/nom_de_zona</code></strong></p>
</li>
<li>
<p>En el servidor DNS mestre, hem de, ara sí, indicar què zones i a qui anem a tranferirlas. S'utilitzaran aquestes línies de configuració:</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">allow-transfer { X.X.X.X };</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">also-notify { X.X.X.X; };</span><span class="w">  </span>
</code></pre></div>
<p>Aquestes línies teniu dues opcions, posar-les perquè actuïn per a cada zona de forma genèrica, en l'arxiu “named.conf.options”.</p>
<p>O podeu posar-la dins de cada zona en què vulguem transferir en el “named.conf.local”, tenint un major control sobre cadascuna d'elles.</p>
<p>En lloc de les X.X.X.X, heu de posar la IP del vostre servidor DNS esclau, que és a qui se li van a transferir les zones.</p>
<ul>
<li>Finalment reinicia el servici de Bind del mestre i de l'esclau.</li>
</ul>
<h3 id="comprovacio-de-la-configuracio">Comprovació de la configuració</h3>
<div class="admonition question">
<p class="admonition-title">Tasca comprovació 1</p>
<ul>
<li>Usant el comando per monitorizar servicis </li>
</ul>
<div class="highlight"><pre><span></span><code>journalctl -u nom_de_servici -f
</code></pre></div>
<p>comprova que es produeix la transferència de zona en l'esclau. Hauries de veure alguna cosa com això:</p>
<p><img alt="" src="../../img/3.2.esclau_2.png" /></p>
<p>Aquí podeu veure com es produeixen les transferències de la zona de resolució directa i de la zona de resolució inversa.</p>
</div>
<div class="admonition question">
<p class="admonition-title">Tasca comprovació 2<ul>
<li>
<p>Comprova que el servidor esclau funciona correctament i resol els noms de dnsserver i cliXubuntu, així com els de Internet. Pots usar qualsevol d'aquests dos comandos:</p>
<p><div class="highlight"><pre><span></span><code>dig nombre.sre.es @X.X.X.X → IP del servidor esclau
nslookup nom X.X.X.X → IP del servidor esclau
</code></pre></div>
Indica en la captura de pantalla on comprovem efectivament que és el servidor esclau el que està resolent la consulta.</p>
</li>
</ul>
</p>
</div>
<div class="admonition question">
<p class="admonition-title">Tasca comprovació 3</p>
<ul>
<li>
<p>Comprova que tot funciona com ha de ser i apaga el servici “named” o “bind9” del servidor principal/mestre.</p>
<p>El servidor esclau hauria de respondre sense problema a les consultes DNS.</p>
</li>
<li>
<p>Adjunta captures de pantalla dels comandos que utilitzis per fer les consultes DNS i indica en elles on podem veure que és el servidor esclau el que està resolent les consultes.</p>
</li>
<li>
<p>Adjunta captura de pantalla dels logs, on es mostra que s'estan rebent consultes (queries).</p>
</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Atenció, nota</p>
<p>Recorda que perquè els clients usin un servidor DNS en cas de fallada d'un altre, aquesta informació l'ha d'enviar el servidor DHCP. Això és, el servidor DHCP haurà d'enviar-li les adreces IP de <strong>tots dos</strong> servidors DNS als clients.</p>
</div>
<h2 id="questions-finals">Questions finals</h2>
<div class="admonition task">
<p class="admonition-title">Questió 1</p>
<p>De quina altra forma, utilitzant un arxiu de configuració de Bind9, podem fer que el subdomini <strong><em>"sre.es"</em></strong> s'afegisca automàticament als noms de la zona, aconseguint lo mateix que en el <strong>Pas 1</strong>?</p>
</div>
<div class="admonition task">
<p class="admonition-title">Questió 2</p>
<p>Explica detalladament què és un servidor mestre o principal i què és un esclau o secundari, així com la rel·lació que tenen.</p>
</div>
<div class="admonition task">
<p class="admonition-title">Questió 3</p>
<p>Explica per a què serveixen aquestes línies i per què hem de posarles a l'arxiu de configuració corresponent:</p>
<div class="highlight"><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">allow-transfer { X.X.X.X };</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">also-notify { X.X.X.X; };</span><span class="w">  </span>
</code></pre></div>
</div>
<div class="admonition task">
<p class="admonition-title">Questió 4</p>
<p>Com saben els clients què quan falla el server DNS principal, ha de començar a utilitzar el secondari?</p>
</div>
<h2 id="avaluacio">Avaluació</h2>
<table>
<thead>
<tr>
<th align="left">Criteri</th>
<th align="center">Puntuació</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Configuració correcta DHCP per a enviar subdomini i <ins>comprovació</ins></td>
<td align="center"><strong>1  punts</strong></td>
</tr>
<tr>
<td align="left">Configuració correcta del servidor DNS com a únic en el client i <ins>comprovació</ins></td>
<td align="center"><strong>0,5 punts</strong></td>
</tr>
<tr>
<td align="left">Configuració correcta dels forwarders i resposta a les questions</td>
<td align="center"><strong>0,5 punts</strong></td>
</tr>
<tr>
<td align="left">Configuració correcta dels logs i <ins>comprovació</ins></td>
<td align="center"><strong>2 punts</strong></td>
</tr>
<tr>
<td align="left">Configuració correcta del servidor esclau i <ins><strong>totes</strong> les comprovacions</ins></td>
<td align="center"><strong>3 punts</strong></td>
</tr>
<tr>
<td align="left">Questions finals</td>
<td align="center"><strong>2 punts</strong></td>
</tr>
<tr>
<td align="left">S'ha tingut cura amb el format del document, utilitzant la plantilla actualitzada i fent ús d'un correcte llenguatge tècnic</td>
<td align="center"><strong>1 punt</strong></td>
</tr>
</tbody>
</table>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../P3.1/" class="md-footer__link md-footer__link--prev" aria-label="Anterior: Pràctica 3.1 - Configuració d&#39;un servidor DNS" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Pràctica 3.1 - Configuració d'un servidor DNS
            </div>
          </div>
        </a>
      
      
        
        <a href="../P3.3/" class="md-footer__link md-footer__link--next" aria-label="Següent: Pràctica 3.3 - Configuració de servidor DNS mestre i esclau en diferents xarxes" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Següent
              </span>
              Pràctica 3.3 - Configuració de servidor DNS mestre i esclau en diferents xarxes
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.expand", "navigation.top", "navigation.indexes", "toc.integrate"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copiat al porta-retalls", "clipboard.copy": "C\u00f2pia al porta-retalls", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Cerca", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "Cap document coincideix", "search.result.one": "1 document coincident", "search.result.other": "# documents coincidents", "search.result.placeholder": "Escriu per a comen\u00e7ar a cercar", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>